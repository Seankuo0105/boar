<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å»èƒŒç¥å™¨</title>
    <link rel="icon" href="https://seankuo0105.github.io/boar/pig.png" type="image/png">
    
    <style>
        :root {
            --primary-color: #4CAF50;
            --accent-color: #FF9800;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            /* é˜²æ­¢åœ¨æ‰‹æ©Ÿä¸Šé•·æŒ‰é¸å–æ–‡å­— */
            user-select: none; 
            -webkit-user-select: none;
            /* é˜²æ­¢æ‰‹æ©Ÿä¸Šä¸‹æ‹‰å‹•é‡æ–°æ•´ç†çš„å½ˆæ€§æ•ˆæœ */
            overscroll-behavior: none;
        }

        header {
            width: 100%;
            background: var(--card-bg);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 15px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .brand img { height: 50px; width: auto; }

        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            max-width: 1100px;
            width: 95%;
            padding-bottom: 50px;
        }

        .panel {
            flex: 1;
            min-width: 320px;
            min-height: 500px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            position: relative;
        }

        .panel-title {
            font-size: 20px;
            color: #555;
            margin-bottom: 15px;
            font-weight: 600;
        }

        /* ä¸Šå‚³å€ */
        #upload-zone {
            border: 3px dashed #ddd;
            border-radius: 15px;
            width: 90%;
            height: 350px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }
        #upload-zone img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* ä¸‹è¼‰èˆ‡ç·¨è¼¯å€ */
        .preview-area {
            width: 90%;
            height: 350px;
            border: 1px solid #eee;
            border-radius: 10px;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAALGPC/xhBQAAAAlwSFlzAAAOwgAADsIBFShKgAAAABp0RVh0U29mdHdhcmUAUGFpbnQuTkVUIHYzLjUuMTAw9HKhAAAAFElEQVQ4T2NkgAJD8Y8wGPVAAQAAT7oGdXqe42cAAAAASUVORK5CYII=');
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
            /* é—œéµï¼šCSS ç¦æ­¢åœ¨æ­¤å€åŸŸç”¢ç”Ÿç€è¦½å™¨é è¨­è§¸æ§è¡Œç‚ºï¼ˆå¦‚æ²å‹•ï¼‰ */
            touch-action: none; 
        }

        canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            /* è®“æ¸¸æ¨™é¡¯ç¤ºç‚ºæº–å¿ƒ */
            cursor: crosshair;
        }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 50px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-secondary { background-color: #e0e0e0; color: #333; }
        .btn-edit { background-color: var(--primary-color); color: white; }
        
        .btn:hover { opacity: 0.9; transform: scale(1.05); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* ç·¨è¼¯å·¥å…·åˆ— */
        #editor-controls {
            display: none;
            width: 90%;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
            border: 1px solid #eee;
        }

        .tool-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .brush-option {
            display: flex;
            gap: 5px;
        }

        .brush-btn {
            padding: 5px 15px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .brush-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        input[type="range"] {
            width: 100px;
        }

    </style>
</head>
<body>

<header>
    <div class="brand">
        <img src="https://seankuo0105.github.io/boar/pig.png" alt="Boar Logo">
        <span>å»èƒŒç¥å™¨</span>
    </div>
</header>

<div class="container">
    <div class="panel">
        <div class="panel-title" style="color: var(--primary-color);">ä¸Šå‚³å€</div>
        <div id="upload-zone" onclick="document.getElementById('file-input').click()">
            <div id="upload-content" style="text-align:center;">
                <div style="font-size:40px; color:#ccc;">+</div>
                <div style="color:#888;">é»æ“Šä¸Šå‚³åœ–ç‰‡</div>
            </div>
            <img id="source-preview" style="display:none;">
        </div>
        <input type="file" id="file-input" accept="image/*" style="display: none;">
    </div>

    <div class="panel">
        <div class="panel-title" style="color: var(--accent-color);">ä¸‹è¼‰ / ç·¨è¼¯å€</div>
        
        <div class="preview-area" id="canvas-container">
            <canvas id="main-canvas"></canvas>
            <div id="placeholder-text" style="color:#aaa;">è«‹å…ˆä¸Šå‚³åœ–ç‰‡</div>
        </div>

        <div id="editor-controls">
            <div class="tool-row">
                <span>å·¥å…·æ¨¡å¼ï¼š</span>
                <div class="brush-option">
                    <button class="brush-btn" id="btn-erase" onclick="setMode('erase')">ğŸ§½ æ“¦é™¤</button>
                    <button class="brush-btn" id="btn-restore" onclick="setMode('restore')">ğŸ–Œï¸ ä¿®å¾©</button>
                </div>
            </div>
            <div class="tool-row">
                <span>ç­†åˆ·å¤§å°ï¼š</span>
                <input type="range" id="brush-size" min="5" max="50" value="20">
                <span id="brush-size-val">20</span>
            </div>
        </div>

        <div class="btn-group">
            <button class="btn btn-edit" id="btn-toggle-edit" onclick="toggleEditMode()" disabled>âœï¸ ç·¨è¼¯å¾®èª¿</button>
            <button class="btn btn-primary" id="btn-download" onclick="downloadImage()" disabled>â¬‡ï¸ ä¸‹è¼‰åœ–ç‰‡</button>
        </div>
        
    </div>
</div>

<script>
    const fileInput = document.getElementById('file-input');
    const uploadZone = document.getElementById('upload-zone');
    const sourcePreview = document.getElementById('source-preview');
    const placeholderText = document.getElementById('placeholder-text');
    
    // Canvas ç›¸é—œ
    const canvas = document.getElementById('main-canvas');
    const ctx = canvas.getContext('2d');
    
    let originalImg = new Image();
    
    // UI å…ƒä»¶
    const editorControls = document.getElementById('editor-controls');
    const btnErase = document.getElementById('btn-erase');
    const btnRestore = document.getElementById('btn-restore');
    const brushSizeInput = document.getElementById('brush-size');
    const brushSizeVal = document.getElementById('brush-size-val');
    const btnDownload = document.getElementById('btn-download');
    const btnToggleEdit = document.getElementById('btn-toggle-edit');

    let currentMode = 'erase'; 
    let isDrawing = false;
    let isEditing = false;
    let brushSize = 20;

    // --- 1. ä¸Šå‚³è™•ç† ---
    fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

    uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.style.backgroundColor = '#f0fff0'; });
    uploadZone.addEventListener('dragleave', (e) => { uploadZone.style.backgroundColor = 'white'; });
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.style.backgroundColor = 'white';
        if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
    });

    function handleFile(file) {
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            sourcePreview.src = e.target.result;
            sourcePreview.style.display = 'block';
            document.getElementById('upload-content').style.display = 'none';

            originalImg = new Image();
            originalImg.onload = () => {
                initCanvas();
                autoRemoveWhite();
                
                btnToggleEdit.disabled = false;
                btnDownload.disabled = false;
                placeholderText.style.display = 'none';
            };
            originalImg.src = e.target.result;
        }
        reader.readAsDataURL(file);
    }

    function initCanvas() {
        // è¨­å®š Canvas å°ºå¯¸ (ä¾ç…§åœ–ç‰‡ï¼Œä½†é™åˆ¶æœ€å¤§é¡¯ç¤ºå¯¬åº¦ä»¥å…è·‘ç‰ˆ)
        canvas.width = originalImg.width;
        canvas.height = originalImg.height;
        ctx.drawImage(originalImg, 0, 0);
    }

    // --- 2. è‡ªå‹•å»ç™½åº• ---
    function autoRemoveWhite() {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        const threshold = 230;

        for (let i = 0; i < data.length; i += 4) {
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];
            if (r > threshold && g > threshold && b > threshold) {
                data[i + 3] = 0;
            }
        }
        ctx.putImageData(imageData, 0, 0);
    }

    // --- 3. ç·¨è¼¯æ¨¡å¼ ---
    function toggleEditMode() {
        isEditing = !isEditing;
        if (isEditing) {
            editorControls.style.display = 'block';
            btnToggleEdit.innerText = 'âŒ çµæŸç·¨è¼¯';
            btnToggleEdit.classList.remove('btn-edit');
            btnToggleEdit.classList.add('btn-secondary');
            setMode('erase');
        } else {
            editorControls.style.display = 'none';
            btnToggleEdit.innerText = 'âœï¸ ç·¨è¼¯å¾®èª¿';
            btnToggleEdit.classList.remove('btn-secondary');
            btnToggleEdit.classList.add('btn-edit');
        }
    }

    function setMode(mode) {
        currentMode = mode;
        if (mode === 'erase') {
            btnErase.classList.add('active');
            btnRestore.classList.remove('active');
        } else {
            btnRestore.classList.add('active');
            btnErase.classList.remove('active');
        }
    }

    brushSizeInput.addEventListener('input', (e) => {
        brushSize = parseInt(e.target.value);
        brushSizeVal.innerText = brushSize;
    });

    // --- 4. ç¹ªåœ–é‚è¼¯ (å«é˜²æ»‘å‹•ä¿®æ­£) ---
    function getEventPos(evt) {
        // çµ±ä¸€è™•ç†æ»‘é¼ èˆ‡è§¸æ§åº§æ¨™
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        let clientX, clientY;
        
        if (evt.touches && evt.touches.length > 0) {
            clientX = evt.touches[0].clientX;
            clientY = evt.touches[0].clientY;
        } else {
            clientX = evt.clientX;
            clientY = evt.clientY;
        }

        return {
            x: (clientX - rect.left) * scaleX,
            y: (clientY - rect.top) * scaleY
        };
    }

    function draw(e) {
        if (!isDrawing || !isEditing) return;
        
        // ç•«ç­†é‚è¼¯
        const pos = getEventPos(e);
        const x = pos.x;
        const y = pos.y;

        ctx.beginPath();
        ctx.arc(x, y, brushSize / 2, 0, Math.PI * 2);

        if (currentMode === 'erase') {
            ctx.globalCompositeOperation = 'destination-out';
            ctx.fill();
        } else {
            ctx.save();
            ctx.clip();
            ctx.globalCompositeOperation = 'source-over';
            ctx.drawImage(originalImg, 0, 0);
            ctx.restore();
        }
        ctx.globalCompositeOperation = 'source-over';
    }

    // --- äº‹ä»¶ç›£è½ (é˜²æ­¢ç•«é¢æ²å‹•çš„é—œéµ) ---
    
    // æ»‘é¼ äº‹ä»¶
    canvas.addEventListener('mousedown', (e) => { 
        isDrawing = true; 
        draw(e); 
    });
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', () => isDrawing = false);
    canvas.addEventListener('mouseout', () => isDrawing = false);

    // è§¸æ§äº‹ä»¶ (æ‰‹æ©Ÿ/å¹³æ¿å°ˆç”¨)
    // passive: false æ˜¯é—œéµï¼Œå…è¨±æˆ‘å€‘ä½¿ç”¨ preventDefault() ä¾†é˜»æ­¢ç€è¦½å™¨æ²å‹•
    canvas.addEventListener('touchstart', (e) => {
        if (isEditing) {
            e.preventDefault(); // ç¦æ­¢ç€è¦½å™¨é è¨­è¡Œç‚º(æ²å‹•)
            isDrawing = true;
            draw(e);
        }
    }, { passive: false });

    canvas.addEventListener('touchmove', (e) => {
        if (isEditing && isDrawing) {
            e.preventDefault(); // æ‹–æ›³æ™‚ç¦æ­¢æ²å‹•
            draw(e);
        }
    }, { passive: false });

    canvas.addEventListener('touchend', (e) => {
        if (isEditing) {
            e.preventDefault();
            isDrawing = false;
        }
    });

    // --- 5. ä¸‹è¼‰ ---
    function downloadImage() {
        const link = document.createElement('a');
        link.download = 'removed_white_bg.png';
        link.href = canvas.toDataURL('image/png');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

</body>
</html>
