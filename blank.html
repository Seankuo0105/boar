<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boar Photo 2.0 - å»èƒŒå·¥å…· (å¿«é€Ÿç‰ˆ)</title>
    <link rel="icon" href="https://seankuo0105.github.io/boar/pig.png" type="image/png">
    
    <style>
        :root {
            --primary-color: #4CAF50;
            --accent-color: #FF9800;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        header {
            width: 100%;
            background: var(--card-bg);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 15px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 40px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .brand img {
            height: 50px;
            width: auto;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 40px;
            justify-content: center;
            max-width: 1000px;
            width: 95%;
            padding-bottom: 50px;
        }

        .panel {
            flex: 1;
            min-width: 300px;
            min-height: 400px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            position: relative;
        }

        .panel-title {
            font-size: 20px;
            color: #555;
            margin-bottom: 20px;
            font-weight: 600;
            width: 100%;
            text-align: center;
        }

        #upload-zone {
            border: 3px dashed #ddd;
            border-radius: 15px;
            width: 90%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        #upload-zone:hover {
            border-color: var(--primary-color);
            background-color: rgba(76, 175, 80, 0.05);
        }

        .preview-img {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: none;
        }

        .btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            display: none;
            box-shadow: 0 4px 6px rgba(255, 152, 0, 0.3);
        }

        .btn:hover { background-color: #f57c00; }

        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none; /* é è¨­éš±è—ï¼Œç”± JS æ§åˆ¶ */
            margin-bottom: 15px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .status {
            color: #666;
            font-size: 14px;
            text-align: center;
            line-height: 1.5;
        }

        /* é è¼‰æŒ‡ç¤ºç‡ˆ */
        .preload-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 10px;
            background: #eee;
            color: #999;
        }
        .preload-badge.ready {
            background: #e8f5e9;
            color: #2e7d32;
        }

    </style>
</head>
<body>

<header>
    <div class="brand">
        <img src="https://seankuo0105.github.io/boar/pig.png" alt="Boar Logo">
        <span>Photo 2.0 å»èƒŒç¥å™¨</span>
    </div>
</header>

<div class="container">
    <div class="panel">
        <div class="panel-title" style="color: var(--primary-color);">ä¸Šå‚³å€</div>
        <div id="upload-zone" onclick="document.getElementById('file-input').click()">
            <div id="upload-content" style="text-align:center;">
                <div style="font-size:40px; color:#ccc;">+</div>
                <div style="color:#888;">é»æ“Šæˆ–æ‹–æ›³åœ–ç‰‡</div>
            </div>
            <img id="source-preview" class="preview-img">
        </div>
        <input type="file" id="file-input" accept="image/*" style="display: none;">
    </div>

    <div class="panel">
        <div class="preload-badge" id="model-status">ç­‰å¾…ä¸‹è¼‰æ¨¡å‹...</div>
        <div class="panel-title" style="color: var(--accent-color);">ä¸‹è¼‰å€</div>
        
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%;">
            <div class="loader" id="loader"></div>
            <div class="status" id="status-text">
                ç³»çµ±æº–å‚™ä¸­...<br>
                <span style="font-size:12px; color:#999;">(ç¶²é é–‹å•Ÿå¾Œæœƒè‡ªå‹•é è¼‰ AI æ¨¡å‹)</span>
            </div>
            <img id="result-preview" class="preview-img">
            <button class="btn" id="download-btn" onclick="downloadImage()">ä¸‹è¼‰ PNG</button>
        </div>
    </div>
</div>

<script type="module">
    import imglyRemoveBackground from "https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.0.3/+esm";

    const statusText = document.getElementById('status-text');
    const modelStatus = document.getElementById('model-status');
    const loader = document.getElementById('loader');
    
    // é è¼‰ç‹€æ…‹æ¨™è¨˜
    let isModelReady = false;

    // --- æ ¸å¿ƒåŠŸèƒ½ï¼šç¶²é è¼‰å…¥å¾Œç«‹å³é è¼‰æ¨¡å‹ ---
    window.addEventListener('load', async () => {
        console.log("Starting model preload...");
        modelStatus.innerText = "ğŸš€ æ­£åœ¨ä¸‹è¼‰ AI æ¨¡å‹...";
        loader.style.display = 'block'; // é¡¯ç¤ºè½‰åœˆåœˆè®“ä½¿ç”¨è€…çŸ¥é“æœ‰äº‹æƒ…åœ¨ç™¼ç”Ÿ

        try {
            // å»ºç«‹ä¸€å€‹ 1x1 çš„é€æ˜åƒç´ åœ–ç‰‡ï¼Œå¼·è¿« AI åŸ·è¡Œä¸€æ¬¡ï¼Œè—‰æ­¤ä¸‹è¼‰æ¨¡å‹
            const emptyImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
            
            await imglyRemoveBackground(emptyImage, {
                progress: (key, current, total) => {
                    // åªé¡¯ç¤ºæ¨¡å‹ä¸‹è¼‰é€²åº¦
                    if (key.includes('model') || key.includes('wasm')) {
                        const percent = Math.round((current / total) * 100);
                        statusText.innerText = `æ­£åœ¨é å…ˆä¸‹è¼‰ AI æ¨¡å‹è³‡æº...\n${percent}%`;
                    }
                }
            });

            // ä¸‹è¼‰å®Œæˆ
            isModelReady = true;
            modelStatus.innerText = "âœ… æ¨¡å‹å·²å°±ç·’";
            modelStatus.classList.add('ready');
            statusText.innerText = "AI æº–å‚™å¥½äº†ï¼\nè«‹ä¸Šå‚³åœ–ç‰‡ã€‚";
            loader.style.display = 'none';

        } catch (error) {
            console.error("Preload error:", error);
            modelStatus.innerText = "âš ï¸ é è¼‰å¤±æ•—";
            statusText.innerText = "è‡ªå‹•é è¼‰å¤±æ•—ï¼Œä½†æ‚¨å¯ä»¥ç›´æ¥ä¸Šå‚³åœ–ç‰‡è©¦è©¦ã€‚";
            loader.style.display = 'none';
        }
    });

    // --- ä»¥ä¸‹ç‚ºåœ–ç‰‡è™•ç†é‚è¼¯ ---
    const fileInput = document.getElementById('file-input');
    const uploadZone = document.getElementById('upload-zone');
    const sourcePreview = document.getElementById('source-preview');
    const resultPreview = document.getElementById('result-preview');
    const downloadBtn = document.getElementById('download-btn');

    fileInput.addEventListener('change', (e) => {
        if (e.target.files[0]) processImage(e.target.files[0]);
    });

    // æ‹–æ›³æ”¯æ´
    uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.style.borderColor = '#4CAF50'; });
    uploadZone.addEventListener('dragleave', (e) => { uploadZone.style.borderColor = '#ddd'; });
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.style.borderColor = '#ddd';
        if (e.dataTransfer.files[0]) processImage(e.dataTransfer.files[0]);
    });

    async function processImage(file) {
        // é¡¯ç¤ºåŸåœ–
        const reader = new FileReader();
        reader.onload = (e) => {
            sourcePreview.src = e.target.result;
            sourcePreview.style.display = 'block';
            document.getElementById('upload-content').style.display = 'none';
            uploadZone.style.border = 'none';
        }
        reader.readAsDataURL(file);

        // é‡ç½®ä»‹é¢
        resultPreview.style.display = 'none';
        downloadBtn.style.display = 'none';
        loader.style.display = 'block';
        
        if (isModelReady) {
            statusText.innerText = "æ­£åœ¨å»èƒŒä¸­... (é€Ÿåº¦æœƒå¾ˆå¿«)";
        } else {
            statusText.innerText = "æ­£åœ¨å»èƒŒä¸­... (æ­£åœ¨ä¸‹è¼‰æ¨¡å‹ï¼Œè«‹ç¨å€™)";
        }

        try {
            // æ­£å¼å»èƒŒ
            const blob = await imglyRemoveBackground(file, {
                progress: (key, current, total) => {
                    // å¦‚æœé‚„æ²’ Readyï¼Œé€™è£¡ä¹Ÿæœƒé¡¯ç¤ºé€²åº¦
                    if (!isModelReady && key.includes('model')) {
                        const percent = Math.round((current / total) * 100);
                        statusText.innerText = `ä¸‹è¼‰æ¨¡å‹ä¸­... ${percent}%`;
                    }
                }
            });

            const url = URL.createObjectURL(blob);
            resultPreview.src = url;
            resultPreview.style.display = 'block';
            downloadBtn.style.display = 'inline-block';
            loader.style.display = 'none';
            statusText.innerText = "å®Œæˆï¼";
            
            // ç¢ºä¿ä¸‹æ¬¡é¡¯ç¤º Ready
            isModelReady = true;
            modelStatus.innerText = "âœ… æ¨¡å‹å·²å°±ç·’";
            modelStatus.classList.add('ready');

            window.finalImageUrl = url;

        } catch (error) {
            console.error(error);
            loader.style.display = 'none';
            statusText.innerText = "è™•ç†å¤±æ•—ï¼Œè«‹æª¢æŸ¥åœ–ç‰‡æ ¼å¼æˆ–ç¶²è·¯ã€‚";
        }
    }

    window.downloadImage = function() {
        if (!window.finalImageUrl) return;
        const link = document.createElement('a');
        link.href = window.finalImageUrl;
        link.download = 'removed-bg.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

</body>
</html>
