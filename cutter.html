<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ–ç‰‡æ‰¹æ¬¡å››åˆ†å‰²å·¥å…· (ZIPè¼¸å‡º)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f6f9;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            color: #333;
        }

        .container {
            background-color: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        h1 { margin-top: 0; color: #2c3e50; }
        p { color: #666; margin-bottom: 30px; }

        /* ä¸Šå‚³å€å¡Šæ¨£å¼ */
        .upload-area {
            border: 2px dashed #cbd5e0;
            padding: 40px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .upload-area:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
            display: block;
        }

        .btn-action {
            margin-top: 20px;
            padding: 12px 30px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            display: none; /* é è¨­éš±è— */
        }

        .btn-action:hover {
            background-color: #2563eb;
        }

        .btn-action:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        /* é€²åº¦æ¢èˆ‡ç‹€æ…‹ */
        .status-box {
            margin-top: 20px;
            text-align: left;
            display: none;
        }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background-color: #e5e7eb;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar {
            height: 100%;
            background-color: #10b981;
            width: 0%;
            transition: width 0.3s;
        }

        .log-text {
            font-size: 14px;
            color: #555;
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        .file-list-preview {
            margin-top: 15px;
            font-size: 0.9em;
            color: #666;
            max-height: 100px;
            overflow-y: auto;
            text-align: left;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>æ‰¹æ¬¡åœ–ç‰‡åˆ‡å‰²å™¨ (ZIP)</h1>
    <p>ä¸€æ¬¡ä¸Šå‚³å¤šå¼µåœ–ç‰‡ï¼Œè‡ªå‹•åˆ‡æˆå››ä»½ä¸¦æ‰“åŒ…ä¸‹è¼‰</p>

    <div class="upload-area">
        <span class="upload-icon">ğŸ“‚</span>
        <span id="upload-text">é»æ“Šæˆ–æ‹–é€™å¤šå¼µåœ–ç‰‡åˆ°é€™è£¡</span>
        <input type="file" id="file-input" accept="image/*" multiple>
    </div>

    <div id="preview-info" class="file-list-preview" style="display:none;"></div>

    <div class="status-box" id="status-box">
        <div class="log-text">
            <span id="status-msg">æº–å‚™ä¸­...</span>
            <span id="percentage">0%</span>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
    </div>

    <button id="process-btn" class="btn-action">é–‹å§‹è™•ç†ä¸¦ä¸‹è¼‰ ZIP</button>
</div>

<script>
    const fileInput = document.getElementById('file-input');
    const processBtn = document.getElementById('process-btn');
    const statusBox = document.getElementById('status-box');
    const statusMsg = document.getElementById('status-msg');
    const percentageText = document.getElementById('percentage');
    const progressBar = document.getElementById('progress-bar');
    const uploadText = document.getElementById('upload-text');
    const previewInfo = document.getElementById('preview-info');

    let selectedFiles = [];

    // ç•¶ä½¿ç”¨è€…é¸æ“‡æª”æ¡ˆæ™‚
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            selectedFiles = Array.from(e.target.files);
            uploadText.textContent = `å·²é¸æ“‡ ${selectedFiles.length} å€‹æª”æ¡ˆ`;
            processBtn.style.display = 'inline-block';
            processBtn.textContent = 'é–‹å§‹è™•ç†ä¸¦ä¸‹è¼‰ ZIP';
            processBtn.disabled = false;
            
            // é‡ç½®é€²åº¦æ¢
            statusBox.style.display = 'none';
            progressBar.style.width = '0%';
            
            // é¡¯ç¤ºæª”æ¡ˆæ¸…å–®é è¦½
            previewInfo.style.display = 'block';
            previewInfo.innerHTML = `<strong>æº–å‚™è™•ç†ï¼š</strong><br>${selectedFiles.map(f => f.name).join(', ')}`;
        }
    });

    processBtn.addEventListener('click', async () => {
        if (selectedFiles.length === 0) return;

        // åˆå§‹åŒ–ä»‹é¢
        processBtn.disabled = true;
        processBtn.textContent = 'è™•ç†ä¸­...';
        statusBox.style.display = 'block';
        const zip = new JSZip(); // å»ºç«‹ ZIP ç‰©ä»¶
        
        let processedCount = 0;
        const totalFiles = selectedFiles.length;

        // å®šç¾©åˆ‡å‰²é‚è¼¯çš„ Promise å‡½å¼
        const processImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const width = img.width;
                        const height = img.height;
                        const halfW = Math.floor(width / 2);
                        const halfH = Math.floor(height / 2);
                        const baseName = file.name.replace(/\.[^/.]+$/, ""); // å»é™¤å‰¯æª”å

                        // å®šç¾©å››å€‹å€å¡Š
                        const parts = [
                            { name: '_01_top_left', x: 0, y: 0 },
                            { name: '_02_top_right', x: 1, y: 0 },
                            { name: '_03_bottom_left', x: 0, y: 1 },
                            { name: '_04_bottom_right', x: 1, y: 1 }
                        ];

                        parts.forEach(part => {
                            const canvas = document.createElement('canvas');
                            canvas.width = halfW;
                            canvas.height = halfH;
                            const ctx = canvas.getContext('2d');
                            
                            ctx.drawImage(
                                img, 
                                part.x * halfW, part.y * halfH, 
                                halfW, halfH, 
                                0, 0, 
                                halfW, halfH
                            );

                            // è½‰æˆ Base64 å­—ä¸² (ç§»é™¤ data:image/png;base64, å‰ç¶´ä»¥æ”¾å…¥ zip)
                            const dataUrl = canvas.toDataURL('image/png');
                            const base64Data = dataUrl.split(',')[1];

                            // åŠ å…¥ ZIP
                            zip.file(`${baseName}${part.name}.png`, base64Data, {base64: true});
                        });

                        processedCount++;
                        updateProgress(processedCount, totalFiles);
                        resolve();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        };

        // ä¾åºåŸ·è¡Œæ‰€æœ‰åœ–ç‰‡è™•ç†
        // ä½¿ç”¨ Promise.all åŒæ™‚è™•ç† (è‹¥åœ–ç‰‡æ¥µå¤šå¯èƒ½éœ€è¦æ”¹ç‚ºå¾ªåºè™•ç†ä»¥é˜²è¨˜æ†¶é«”çˆ†é‡ï¼Œä½†ä¸€èˆ¬ä½¿ç”¨ Promise.all è¼ƒå¿«)
        try {
            await Promise.all(selectedFiles.map(file => processImage(file)));

            statusMsg.textContent = "æ­£åœ¨æ‰“åŒ…å£“ç¸®...";
            
            // ç”¢ç”Ÿ ZIP æª”
            const content = await zip.generateAsync({type: "blob"});
            
            // ä¸‹è¼‰ ZIP
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = "cut_images_batch.zip";
            link.click();

            statusMsg.textContent = "ä¸‹è¼‰å®Œæˆï¼";
            processBtn.textContent = "å®Œæˆ";
            processBtn.disabled = false;

        } catch (error) {
            console.error(error);
            statusMsg.textContent = "ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥åœ–ç‰‡æ ¼å¼";
        }
    });

    function updateProgress(current, total) {
        const percent = Math.round((current / total) * 100);
        progressBar.style.width = `${percent}%`;
        percentageText.textContent = `${percent}%`;
        statusMsg.textContent = `æ­£åœ¨è™•ç†: ${current} / ${total}`;
    }
</script>

</body>
</html>
