<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>é¸è™Ÿå™¨</title>
  <link rel="icon" href="https://seankuo0105.github.io/boar/pig.png">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      margin: 0;
      padding: 20px;
      background: #f8fafc;
      color: #111;
      text-align: center;
    }
    h1 { margin-bottom: 20px; }
    #controls { margin-bottom: 20px; }
    button {
      padding: 10px 16px;
      margin: 5px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #2563eb;
      color: #fff;
      font-size: 15px;
    }
    #result {
      font-size: 28px;
      margin: 20px;
      font-weight: bold;
      color: #e11d48;
      min-height: 40px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th { background: #f1f5f9; }
    .pig-icon {
      position: fixed;
      right: 20px;
      bottom: 20px;
      width: 60px;
      height: 60px;
    }

    /* overlay (åŸæœ¬é¸è™Ÿ) */
    #overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 1000;
    }
    #overlay img {
      width: 200px;
      margin-bottom: 20px;
      cursor: pointer;
    }
    #overlay p {
      color: white;
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    #overlay #jumpNumber {
      font-size: 60px;
      color: yellow;
      margin-top: 10px;
    }

    /* æˆ³æˆ³æ¨‚è¦–çª— */
    #punchModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 600px;
      max-width: 90vw;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      z-index: 1500;
      padding: 20px;
      text-align: center;
    }
    #punchClose {
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 20px;
      color: #555;
      cursor: pointer;
    }
    #punchArea {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 30px;
      margin-top: 30px;
    }
    .punchPig {
      width: 120px;
      height: 120px;
      cursor: pointer;
    }
    .punchNumber {
      font-size: 28px;
      color: #000;
      text-align: center;
      margin-top: -20px;
    }
    #restartPunch {
      display: none;
      padding: 10px 20px;
      background: #22c55e;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      color: #fff;
      border: none;
    }

    /* é–‹å ´å‹•ç•« */
    #introPig {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: black;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      transition: opacity 3s ease;
    }
    #introPig img {
      width: 50%;
      max-width: 400px;
    }

    /* é›¢é–‹æŒ‰éˆ• */
    #exitBtn {
      background: #ef4444;
    }
  </style>
</head>
<body>

<div id="introPig"><img src="https://seankuo0105.github.io/boar/pig4k.png" alt="å±±è±¬"></div>

<h1>ğŸ² é¸è™Ÿå™¨</h1>
<div id="controls">
  <input type="file" id="fileInput" accept=".csv,.xlsx" />
  <button onclick="generateTable()">â• ç”Ÿæˆè¼¸å…¥è¡¨æ ¼</button>
  <button onclick="showOverlay()">ğŸ¯ é¸è™Ÿ</button>
  <button onclick="openPunch()">ğŸ¯ æˆ³æˆ³æ¨‚é¸è™Ÿ</button>
  <button onclick="exportTable()">ğŸ’¾ åŒ¯å‡ºåå–®</button>
  <button onclick="window.open('https://seankuo0105.github.io/boar/fruit.html','_blank')">ğŸ å‰å¾€æ°´æœéŠæˆ²</button>
  <button id="exitBtn" onclick="exitApp()">ğŸšª é›¢é–‹</button>
</div>

<div id="result">ğŸ‘‰ å°šæœªæŠ½ç±¤</div>
<table id="dataTable">
  <thead>
    <tr>
      <th>åº§è™Ÿ</th>
      <th>å§“å</th>
      <th>è«‹å‡/ä¸åƒèˆ‡</th>
      <th>å·²æŠ½åˆ°</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<img src="https://seankuo0105.github.io/boar/pig.png" alt="å±±è±¬" class="pig-icon">

<!-- åŸæœ¬é¸è™Ÿ Overlay -->
<div id="overlay">
  <img src="https://seankuo0105.github.io/boar/pig.png" alt="å±±è±¬" id="overlayPig">
  <p>é»å±±è±¬é–‹å§‹é¸è™Ÿ</p>
  <div id="jumpNumber"></div>
</div>

<!-- æˆ³æˆ³æ¨‚è¦–çª— -->
<div id="punchModal">
  <span id="punchClose" onclick="closePunch()">âŒ</span>
  <h2>ğŸ— æˆ³æˆ³æ¨‚é¸è™Ÿ</h2>
  <div id="punchArea"></div>
  <button id="restartPunch" onclick="startPunch()">ğŸ” é‡æ–°é–‹å§‹</button>
</div>

<script>
let students = [];
let picked = new Set();
let jumping = false;

window.onload = function() {
  const intro = document.getElementById("introPig");
  setTimeout(() => {
    intro.style.opacity = "0";
    setTimeout(()=> intro.remove(), 3000);
  }, 500);
};

document.getElementById("fileInput").addEventListener("change", handleFile, false);

function handleFile(e) {
  const file = e.target.files[0];
  const reader = new FileReader();
  if (file.name.endsWith(".csv")) {
    reader.onload = function(e) {
      const rows = e.target.result.split("\n").map(r => r.split(","));
      students = rows.filter(r => r[0] && r[1]).map(r => ({
        number: r[0].trim(),
        name: r[1].trim(),
        absent: false
      }));
      renderTable();
    };
    reader.readAsText(file, "utf-8");
  } else if (file.name.endsWith(".xlsx")) {
    reader.onload = function(e) {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
      students = rows.filter(r => r[0] && r[1]).map(r => ({
        number: r[0],
        name: r[1],
        absent: false
      }));
      renderTable();
    };
    reader.readAsArrayBuffer(file);
  }
}

function generateTable() {
  let count = prompt("è«‹è¼¸å…¥å­¸ç”Ÿæ•¸é‡ï¼š", "10");
  if (!count) return;
  students = [];
  for (let i=1; i<=count; i++) {
    students.push({ number: i, name: "", absent: false });
  }
  renderTable(true);
}

function renderTable(editable=false) {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";
  students.forEach((s, idx) => {
    let row = document.createElement("tr");
    row.innerHTML = `
      <td>${s.number}</td>
      <td contenteditable="${editable}" oninput="students[${idx}].name=this.innerText">${s.name}</td>
      <td><input type="checkbox" onchange="students[${idx}].absent=this.checked" ${s.absent?"checked":""}></td>
      <td>${picked.has(s.number) ? "âœ…" : ""}</td>
    `;
    tbody.appendChild(row);
  });
}

function showOverlay() {
  document.getElementById("overlay").style.display = "flex";
}
document.getElementById("overlayPig").addEventListener("click", startJump);

function startJump() {
  if (jumping) return;
  jumping = true;
  let candidates = students.filter(s => !s.absent && !picked.has(s.number));
  if (candidates.length === 0) {
    alert("ğŸ‰ å…¨éƒ¨æŠ½å®Œï¼Œé‡ç½®åå–®ï¼");
    picked.clear();
    renderTable();
    document.getElementById("result").innerText = "ğŸ‘‰ å°šæœªæŠ½ç±¤";
    document.getElementById("overlay").style.display="none";
    jumping = false;
    return;
  }

  const overlay = document.getElementById("overlay");
  const jumpNumber = document.getElementById("jumpNumber");

  let interval = 30;
  let count = 0;
  let maxCount = 20;
  let timer = setInterval(function tick() {
    let rand = candidates[Math.floor(Math.random() * candidates.length)];
    jumpNumber.innerText = rand.number;
    count++;
    if(count>=maxCount){
      clearInterval(timer);
      let chosen = candidates[Math.floor(Math.random() * candidates.length)];
      picked.add(chosen.number);
      document.getElementById("result").innerText = `ğŸ¯ æŠ½åˆ°ï¼š${chosen.number} è™Ÿ ${chosen.name}`;
      renderTable();
      jumpNumber.innerText = chosen.number;
      setTimeout(()=>{overlay.style.display="none"; jumping=false;},1500);
    } else {
      interval += 25;
      clearInterval(timer);
      timer = setInterval(tick, interval);
    }
  }, interval);
}

function openPunch() {
  document.getElementById("punchModal").style.display = "block";
  startPunch();
}
function closePunch() {
  document.getElementById("punchModal").style.display = "none";
}

function startPunch() {
  const area = document.getElementById("punchArea");
  const restart = document.getElementById("restartPunch");
  area.innerHTML = "";
  restart.style.display = "none";

  let candidates = students.filter(s => !s.absent && !picked.has(s.number));
  if (candidates.length < 5) candidates = students.filter(s => !s.absent);

  let count = 0;
  for (let i=0; i<5; i++) {
    let div = document.createElement("div");
    let img = document.createElement("img");
    img.src = "https://seankuo0105.github.io/boar/pig.png";
    img.className = "punchPig";
    let num = document.createElement("div");
    num.className = "punchNumber";
    num.style.display = "none";
    div.appendChild(img);
    div.appendChild(num);
    area.appendChild(div);

    img.onclick = () => {
      img.style.display = "none";
      let chosen = candidates[Math.floor(Math.random()*candidates.length)];
      picked.add(chosen.number);
      num.innerText = chosen.number;
      num.style.display = "block";
      document.getElementById("result").innerText = `ğŸ¯ æŠ½åˆ°ï¼š${chosen.number} è™Ÿ ${chosen.name}`;
      renderTable();
      count++;
      if (count === 5) restart.style.display = "inline-block";
    };
  }
}

function exportTable() {
  let csv = students.map(s => `${s.number},${s.name}`).join("\n");
  let blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  let url = URL.createObjectURL(blob);
  let a = document.createElement("a");
  a.href = url;
  a.download = "students.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function exitApp() {
  if (confirm("ç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ")) {
    document.body.innerHTML = "<h1>ğŸ‘‹ æ„Ÿè¬ä½¿ç”¨é¸è™Ÿå™¨ï¼</h1>";
    setTimeout(()=>window.close(), 1000);
  }
}
</script>

</body>
</html>
